#include <asm/regdef.h>
#include <asm/cp0regdef.h>
#include <asm/asm.h>
#include <stackframe.h>

.macro	__build_clear_sti
	STI
.endm

.macro	__build_clear_cli
	CLI
.endm

.macro	BUILD_HANDLER exception handler clear
	.align	5
	NESTED(handle_\exception, TF_SIZE, sp)  
	.set	noat

nop

	SAVE_ALL				
	__build_clear_\clear
	.set	at
	move	a0, sp
	jal	\handler
	nop
	j	ret_from_exception
	nop
	END(handle_\exception)
.endm

FEXPORT(ret_from_exception)
	.set noat
	.set noreorder
	RESTORE_SOME
	.set at
	lw	k0,TF_EPC(sp)				 
	lw	sp,TF_REG29(sp) /* Deallocate stack */  
//1:	j	1b
	nop
	jr	k0								 
	rfe								 



.set noreorder
.align	5
NESTED(handle_int, TF_SIZE, sp)  // 处理中断异常
.set	noat

//1: j 1b
nop

SAVE_ALL
CLI
.set	at
mfc0	t0, CP0_CAUSE
mfc0	t2, CP0_STATUS
and	t0, t2                   // t0中保存中断号

andi	t1, t0, STATUSF_IP4  // 检查是不是4号中断位引起的中断，如果是则跳转到time_irq
bnez	t1, timer_irq        // timer_irq: 中断服务函数
nop
END(handle_int)

	.extern delay

timer_irq:

	sb zero, 0xb5000110
1:	j	sched_yield
	nop
	/*li t1, 0xff
	lw    t0, delay
	addu  t0, 1
	sw	t0, delay
	beq	t0,t1,1f	
	nop*/
	j	ret_from_exception
	nop

LEAF(do_reserved)
END(do_reserved)

	.extern tlbra
.set	noreorder
NESTED(do_refill,0 , sp)
// 处理缺页中断：如果物理页面在页表中存在，则会将其填入 TLB 并 返回异常地址再次执行内存存取的指令。
// 如果物理页面不存在，则会触发一个一般意义的缺页错误，并跳转到 mm/pmap.c 中的 pageout 函数中。
// 如果存取地址是合法的用户空间地址，内核会为对应地址分配并映射一个物理页面（被动地分配页面）来解 决缺页的问题。
			//li	k1, '?'
			//sb	k1, 0x90000000
			.extern	mCONTEXT
//this "1" is important
1:			//j 1b
			nop
			lw		k1,mCONTEXT
			and		k1,0xfffff000
				mfc0		k0,CP0_BADVADDR
				srl		k0,20
				and		k0,0xfffffffc
			addu		k0,k1
			
			lw		k1,0(k0)
			nop
					move		t0,k1
					and		t0,0x0200
					beqz		t0,NOPAGE
			nop
			and		k1,0xfffff000
				mfc0		k0,CP0_BADVADDR
				srl		k0,10
				and		k0,0xfffffffc
				and		k0,0x00000fff
			addu		k0,k1

			or		k0,0x80000000
			lw		k1,0(k0)
			nop
					move		t0,k1
					and		t0,0x0200
					beqz		t0,NOPAGE
			nop
			move		k0,k1
			and		k0,0x1
			beqz		k0,NoCOW
			nop
			and		k1,0xfffffbff
NoCOW:
			mtc0		k1,CP0_ENTRYLO0
			nop
			tlbwr

			j		2f
			nop
NOPAGE:
//3: j 3b
nop
			mfc0		a0,CP0_BADVADDR
			lw		a1,mCONTEXT
			nop
				
			sw	 	ra,tlbra
			jal		pageout
			nop
//3: j 3b
nop
			lw		ra,tlbra
			nop

			j	1b
2:			nop

			jr		ra
			nop
END(do_refill)



BUILD_HANDLER reserved do_reserved cli
BUILD_HANDLER tlb	do_refill	cli
BUILD_HANDLER mod	page_fault_handler cli



